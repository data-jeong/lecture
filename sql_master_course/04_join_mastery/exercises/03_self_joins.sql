-- Chapter 04: 조인(JOIN) 마스터하기 - SELF JOIN 특화 연습
-- 난이도: 중급-고급

-- =============================================================================
-- 1. 계층 구조 분석 (Hierarchical Data)
-- =============================================================================

-- 1-1. 조직도 기본 조회
-- 모든 직원과 그들의 직속 상사를 조회하세요.
-- (직원ID, 직원명, 직급, 상사ID, 상사명, 상사직급)


-- 1-2. 최고 경영진 조회
-- 상사가 없는 직원들(CEO, 임원 등)을 조회하세요.


-- 1-3. 특정 매니저의 직속 부하직원 조회
-- 매니저ID가 5인 직원의 모든 직속 부하직원을 조회하세요.


-- 1-4. 조직 레벨별 직원 수 조회
-- 각 조직 레벨(CEO=1, 임원=2, 부장=3, ...)별 직원 수를 조회하세요.


-- =============================================================================
-- 2. 재귀적 계층 구조 (Recursive Hierarchy)
-- =============================================================================

-- 2-1. 특정 매니저 하위의 모든 직원 조회 (재귀 CTE 사용)
-- 매니저ID가 3인 직원의 모든 하위 직원들을 레벨과 함께 조회하세요.


-- 2-2. 조직 경로 추적
-- 각 직원에서 CEO까지의 전체 경로를 조회하세요.
-- (직원명, 레벨, 상급자 경로)


-- 2-3. 팀별 총 인원 수 계산
-- 각 팀 리더별로 그 하위의 총 인원 수를 계산하세요.
-- (팀 리더명, 직속 부하 수, 전체 하위 직원 수)


-- =============================================================================
-- 3. 급여 및 성과 비교 분석
-- =============================================================================

-- 3-1. 동일 부서 내 급여 순위
-- 각 직원의 부서 내 급여 순위를 SELF JOIN으로 계산하세요.
-- (직원명, 부서, 급여, 부서 내 순위)


-- 3-2. 급여 분포 분석
-- 각 직원보다 급여가 높은/낮은 직원 수를 조회하세요.
-- (직원명, 급여, 자신보다 높은 급여 직원 수, 자신보다 낮은 급여 직원 수)


-- 3-3. 상사와 부하직원 급여 비교
-- 상사의 급여가 부하직원보다 낮은 경우를 찾으세요.
-- (부하직원명, 부하 급여, 상사명, 상사 급여, 급여 차이)


-- 3-4. 팀 내 급여 격차 분석
-- 각 팀에서 최고 급여와 최저 급여의 차이를 조회하세요.


-- =============================================================================
-- 4. 시간 기반 SELF JOIN
-- =============================================================================

-- 4-1. 연속 주문 고객 분석
-- 연속된 2일 내에 여러 번 주문한 고객을 찾으세요.
-- (고객명, 첫 번째 주문일, 두 번째 주문일, 주문 간격 시간)


-- 4-2. 매출 성장률 계산
-- 각 월의 매출과 전월 대비 성장률을 SELF JOIN으로 계산하세요.
-- (년월, 당월 매출, 전월 매출, 성장률)


-- 4-3. 재주문 패턴 분석
-- 같은 상품을 여러 번 주문한 고객의 재주문 간격을 분석하세요.
-- (고객명, 상품명, 첫 주문일, 재주문일, 재주문 간격일수)


-- 4-4. 계절별 매출 비교
-- 작년 동기 대비 매출 성장률을 분석하세요.
-- (월, 올해 매출, 작년 동기 매출, 성장률)


-- =============================================================================
-- 5. 순위 및 랭킹 시스템
-- =============================================================================

-- 5-1. 부서별 TOP 3 직원
-- 각 부서에서 급여 상위 3명의 직원을 SELF JOIN으로 찾으세요.


-- 5-2. 매출 실적 순위
-- 각 영업사원의 분기별 매출 순위를 계산하세요.
-- (직원명, 분기, 매출액, 해당 분기 순위)


-- 5-3. 고객 충성도 순위
-- 총 구매 금액 기준으로 고객 순위를 매기고, 
-- 상위 10% 고객을 VIP로 분류하세요.


-- =============================================================================
-- 6. 네트워크 분석
-- =============================================================================

-- 6-1. 친구 관계 분석 (소셜 네트워크)
-- friends 테이블에서 공통 친구를 가진 사용자들을 찾으세요.
-- (사용자A, 사용자B, 공통 친구 수)


-- 6-2. 추천 시스템
-- 비슷한 구매 패턴을 가진 고객들을 찾아 상품 추천 데이터를 생성하세요.
-- (고객A, 고객B, 공통 구매 상품 수, 유사도 점수)


-- 6-3. 영향력 분석
-- 조직에서 가장 많은 직원을 관리하는 매니저들을 찾으세요.
-- (매니저명, 직속 부하 수, 간접 부하 수, 총 영향력 점수)


-- =============================================================================
-- 7. 데이터 품질 및 이상 탐지
-- =============================================================================

-- 7-1. 순환 참조 탐지
-- 조직도에서 순환 참조(A가 B의 상사이면서 B가 A의 상사)가 있는지 확인하세요.


-- 7-2. 고아 노드 탐지
-- 존재하지 않는 상사를 참조하는 직원들을 찾으세요.


-- 7-3. 깊이 이상 탐지
-- 조직도에서 비정상적으로 깊은 계층(7단계 이상)을 가진 경로를 찾으세요.


-- 7-4. 중복 데이터 탐지
-- 같은 이름과 부서를 가진 직원이 여러 명 있는지 확인하세요.


-- =============================================================================
-- 8. 복잡한 비즈니스 로직
-- =============================================================================

-- 8-1. 승진 후보자 추천
-- 다음 조건을 만족하는 승진 후보자를 찾으세요:
-- - 현재 직급에서 2년 이상 근무
-- - 부하직원이 3명 이상
-- - 급여가 동일 직급 평균보다 높음


-- 8-2. 팀 재편성 분석
-- 현재 팀 구조에서 비효율적인 부분을 찾으세요:
-- - 부하가 없는 매니저
-- - 한 명만 관리하는 매니저
-- - 10명 이상 관리하는 매니저


-- 8-3. 멘토-멘티 매칭
-- 경력과 부서를 고려하여 최적의 멘토-멘티 조합을 찾으세요.
-- (멘토는 5년 이상 경력, 멘티는 2년 이하 경력, 같은 부서 또는 관련 부서)


-- =============================================================================
-- 9. 성능 최적화 도전 과제
-- =============================================================================

-- 9-1. 대용량 조직도 조회 최적화
-- 10만 명 이상의 직원이 있는 조직에서 
-- 특정 매니저의 모든 하위 직원을 효율적으로 조회하는 방법을 제시하세요.


-- 9-2. 실시간 순위 업데이트
-- 매출 데이터가 실시간으로 업데이트될 때, 
-- 각 직원의 순위를 효율적으로 유지하는 방법을 제시하세요.


-- 9-3. 메모리 효율적인 재귀 쿼리
-- 깊은 계층 구조에서 메모리 사용량을 최소화하면서 
-- 전체 계층을 조회하는 방법을 제시하세요.


-- =============================================================================
-- 10. 실전 응용 문제
-- =============================================================================

-- 10-1. 조직 개편 시뮬레이션
-- 특정 매니저가 퇴사할 경우, 그 하위 조직이 어떻게 재편되어야 하는지 
-- 시뮬레이션하세요.


-- 10-2. 급여 예산 계획
-- 각 팀별로 내년도 급여 예산을 계획할 때, 
-- 승진과 인상을 고려한 총 예산을 계산하세요.


-- 10-3. 업무 위임 체계 분석
-- 휴가나 출장으로 부재 시 업무를 위임받을 수 있는 
-- 대체 인력을 체계적으로 찾는 쿼리를 작성하세요.


-- 10-4. 리더십 파이프라인 분석
-- 향후 5년간 예상되는 퇴직자를 고려하여 
-- 리더십 포지션의 후계자를 식별하세요.