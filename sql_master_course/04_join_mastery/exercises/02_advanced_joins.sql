-- Chapter 04: 조인(JOIN) 마스터하기 - 고급 조인 연습
-- 난이도: 중급-고급

-- =============================================================================
-- 1. 복잡한 SELF JOIN
-- =============================================================================

-- 1-1. 조직도 생성: 각 직원과 그의 모든 상급자들을 계층적으로 조회하세요.
-- (재귀적 CTE나 여러 단계 SELF JOIN 사용)


-- 1-2. 같은 부서 내에서 자신보다 급여가 높은 동료가 몇 명인지 조회하세요.
-- (직원명, 부서명, 급여, 자신보다 급여가 높은 동료 수)


-- 1-3. 연속된 날짜에 주문한 고객들을 찾으세요.
-- (고객명, 첫 번째 주문일, 두 번째 주문일, 두 주문간 일수 차이)


-- =============================================================================
-- 2. 조건부 복합 JOIN
-- =============================================================================

-- 2-1. 고객 유형에 따라 다른 할인 정책을 적용한 주문 정보를 조회하세요.
-- - VIP 고객: 10% 할인
-- - 일반 고객: 5% 할인
-- - 신규 고객: 3% 할인
-- (고객명, 주문번호, 원래 금액, 할인율, 할인 후 금액)


-- 2-2. 상품 카테고리별로 다른 배송비 정책을 적용한 주문 내역을 조회하세요.
-- - 전자제품: 무료배송 (50만원 이상 주문시)
-- - 의류: 3000원 (3만원 이상 무료)
-- - 기타: 5000원 (5만원 이상 무료)


-- 2-3. 계절별 할인 상품과 일반 상품을 구분하여 판매 현황을 조회하세요.
-- (상품명, 카테고리, 계절, 원가, 할인가, 총 판매량, 총 매출)


-- =============================================================================
-- 3. 서브쿼리와 JOIN 조합
-- =============================================================================

-- 3-1. 평균 주문 금액보다 큰 주문을 한 고객들의 상세 정보를 조회하세요.
-- (고객명, 주문 건수, 평균 주문 금액, 최고 주문 금액)


-- 3-2. 각 카테고리에서 가장 많이 팔린 상품과, 해당 카테고리의 총 매출을 조회하세요.
-- (카테고리명, 베스트 상품명, 상품 판매량, 카테고리 총 매출)


-- 3-3. 직원별 매출 실적이 부서 평균보다 높은 직원들을 조회하세요.
-- (직원명, 부서명, 개인 매출, 부서 평균 매출, 차이)


-- =============================================================================
-- 4. 윈도우 함수와 JOIN
-- =============================================================================

-- 4-1. 각 고객의 주문 이력과 누적 주문 금액을 조회하세요.
-- (고객명, 주문일, 주문 금액, 누적 주문 금액, 주문 순번)


-- 4-2. 월별 매출 현황과 전월 대비 증감률을 조회하세요.
-- (년월, 월 매출, 전월 매출, 증감률, 순위)


-- 4-3. 각 상품의 일별 판매량과 7일 이동평균을 조회하세요.
-- (상품명, 판매일, 일별 판매량, 7일 이동평균)


-- =============================================================================
-- 5. FULL OUTER JOIN과 데이터 품질 검증
-- =============================================================================

-- 5-1. 고객 테이블과 주문 테이블의 데이터 무결성을 검증하세요.
-- (존재하지 않는 고객의 주문, 주문이 없는 고객 구분)


-- 5-2. 상품 재고와 실제 판매 데이터의 일치성을 검증하세요.
-- (재고는 있지만 판매 기록이 없는 상품, 판매는 있지만 재고 정보가 없는 상품)


-- 5-3. 직원 테이블과 급여 테이블의 데이터 일관성을 검증하세요.
-- (급여 정보가 없는 직원, 직원 정보가 없는 급여 기록)


-- =============================================================================
-- 6. 성능 최적화 문제
-- =============================================================================

-- 6-1. 대용량 주문 데이터에서 최근 1개월 고객별 구매 패턴을 효율적으로 조회하세요.
-- (필요한 인덱스도 제안하세요)


-- 6-2. 상품 추천을 위한 고객별 구매 유사도를 계산하세요.
-- (같은 상품을 구매한 고객들 간의 유사도)


-- 6-3. 재고 회전율이 낮은 상품들을 효율적으로 찾는 쿼리를 작성하세요.
-- (최근 6개월 판매량, 현재 재고량, 회전율 계산)


-- =============================================================================
-- 7. 비즈니스 인텔리전스 쿼리
-- =============================================================================

-- 7-1. 고객 세그먼테이션 분석
-- RFM (Recency, Frequency, Monetary) 분석을 수행하세요.
-- - Recency: 최근 구매일로부터 지난 일수
-- - Frequency: 총 구매 횟수
-- - Monetary: 총 구매 금액
-- 각각을 1-5점으로 등급화하여 고객을 세그먼트별로 분류


-- 7-2. 코호트 분석 (Cohort Analysis)
-- 월별 신규 고객의 재구매율을 분석하세요.
-- (첫 구매 월, 1개월 후 재구매율, 2개월 후 재구매율, 3개월 후 재구매율)


-- 7-3. 교차 판매 (Cross-selling) 분석
-- 함께 구매되는 상품들의 패턴을 분석하세요.
-- (상품A, 상품B, 함께 구매된 횟수, 지지도, 신뢰도)


-- =============================================================================
-- 8. 고급 실전 문제
-- =============================================================================

-- 8-1. 공급망 분석
-- 공급업체별 납기 준수율과 품질 점수를 종합하여 
-- 공급업체 성과 리포트를 생성하세요.


-- 8-2. 직원 성과 분석
-- 영업 직원별 월간 실적과 목표 달성률, 팀 내 순위를 조회하세요.
-- (직원명, 부서, 월 매출, 목표 매출, 달성률, 팀 내 순위, 전사 순위)


-- 8-3. 이벤트 효과 분석
-- 마케팅 이벤트 전후의 매출 변화를 분석하세요.
-- (이벤트명, 이벤트 기간, 이벤트 전 평균 일매출, 이벤트 중 평균 일매출, 증감률)


-- 8-4. 고객 이탈 예측 데이터
-- 이탈 가능성이 높은 고객들을 식별하기 위한 특성 데이터를 생성하세요.
-- (고객명, 마지막 구매일, 평균 구매 주기, 총 구매 금액, 평균 주문 금액,
--  구매 빈도 감소 여부, 이탈 위험도)


-- =============================================================================
-- 9. 도전 문제 (Expert Level)
-- =============================================================================

-- 9-1. 동적 피벗 분석
-- 각 고객의 월별 카테고리별 구매 금액을 피벗 테이블 형태로 조회하세요.
-- (고객명, 1월_전자제품, 1월_의류, 2월_전자제품, 2월_의류, ...)


-- 9-2. 재귀적 조직도
-- 특정 매니저 하위의 모든 직원들을 계층 구조로 조회하세요.
-- (레벨, 직원명, 직속상사, 최고상사, 경로)


-- 9-3. 복잡한 할부 계산
-- 할부 상품 주문에 대해 월별 할부금과 잔금을 계산하세요.
-- (고객명, 상품명, 총액, 할부개월, 월 할부금, 각 월별 잔금)


-- 9-4. 시계열 데이터 갭 분석
-- 연속된 판매 데이터에서 누락된 날짜들을 찾고, 
-- 전후 데이터를 이용해 예상 매출을 추정하세요.