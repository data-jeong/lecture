-- Chapter 05: CTE (Common Table Expression) 실습 문제
-- 각 문제를 해결하는 SQL 쿼리를 작성하세요.

-- 문제 1: 기본 CTE를 사용하여 월별 매출 현황을 조회하세요.
-- CTE로 월별 매출을 계산하고, 전월 대비 증감률을 함께 표시하세요.
-- 결과: 년월, 월별 매출, 전월 매출, 증감률(%)
-- 힌트: WITH monthly_sales AS (...) 형태로 시작


-- 문제 2: 다중 CTE를 사용하여 고객 세그멘테이션을 수행하세요.
-- 첫 번째 CTE: 고객별 총 구매액 계산
-- 두 번째 CTE: 구매액 기준 분위 계산
-- 최종: 고객명, 총 구매액, 고객 등급(VIP/Premium/Standard/Basic)
-- 힌트: 여러 개의 CTE를 콤마로 연결


-- 문제 3: 재귀 CTE를 사용하여 조직도 계층 구조를 조회하세요.
-- employees 테이블의 manager_id를 이용하여 전체 조직 계층을 표시하세요.
-- 결과: 직원명, 직급, 매니저명, 계층 레벨, 계층 경로
-- 힌트: WITH RECURSIVE 사용


-- 문제 4: CTE를 사용하여 상품별 판매 트렌드를 분석하세요.
-- 최근 12개월의 월별 판매량과 3개월 이동평균을 계산하세요.
-- 결과: 상품명, 년월, 월별 판매량, 3개월 이동평균, 트렌드 방향
-- 힌트: CTE에서 윈도우 함수와 LAG 활용


-- 문제 5: 재귀 CTE로 카테고리 계층 구조를 탐색하세요.
-- categories 테이블에 parent_category_id가 있다고 가정하고,
-- 특정 카테고리의 모든 하위 카테고리를 조회하세요.
-- 결과: 카테고리명, 상위 카테고리, 계층 레벨, 전체 경로
-- 힌트: RECURSIVE CTE로 트리 구조 탐색


-- 문제 6: CTE를 사용하여 고객별 RFM 분석을 수행하세요.
-- Recency, Frequency, Monetary 각각을 5점 척도로 계산하세요.
-- 결과: 고객명, R점수, F점수, M점수, 총 RFM 점수, 고객 등급
-- 힌트: 각 지표별로 분리된 CTE 구성


-- 문제 7: 복잡한 계층 쿼리를 CTE로 단순화하세요.
-- 부서별 → 팀별 → 개인별 성과 집계를 단계별로 수행하세요.
-- 결과: 부서, 팀, 직원명, 개인 성과, 팀 평균, 부서 평균, 전체 평균
-- 힌트: 여러 레벨의 GROUP BY를 CTE로 분리


-- 문제 8: 시계열 데이터의 갭을 CTE로 식별하세요.
-- 일별 매출 데이터에서 누락된 날짜를 찾아 0으로 채우세요.
-- 결과: 날짜, 실제 매출, 보정된 매출, 데이터 존재여부
-- 힌트: 날짜 시리즈 생성 CTE와 LEFT JOIN


-- 문제 9: 재귀 CTE로 팩토리얼을 계산하세요.
-- 1부터 10까지의 팩토리얼 값을 재귀적으로 계산하세요.
-- 결과: 숫자, 팩토리얼 값
-- 힌트: 기본 케이스(1! = 1)와 재귀 케이스 정의


-- 문제 10: CTE를 사용하여 고객 생애 가치(CLV)를 계산하세요.
-- 고객별 평균 주문 금액, 주문 빈도, 예상 생애 기간을 종합하여 CLV 산정
-- 결과: 고객명, 평균 주문액, 연간 주문 빈도, 예상 생애(년), CLV
-- 힌트: 각 구성 요소를 별도 CTE로 계산


-- 문제 11: 재귀 CTE로 피보나치 수열을 생성하세요.
-- 1부터 20번째까지의 피보나치 수를 계산하세요.
-- 결과: 순서, 피보나치 값, 황금비율 근사값
-- 힌트: 이전 두 값을 더하는 재귀 구조


-- 문제 12: CTE를 사용하여 복잡한 재고 관리 분석을 수행하세요.
-- 상품별 입고/출고 내역을 집계하여 현재 재고와 회전율을 계산하세요.
-- 결과: 상품명, 시작 재고, 총 입고, 총 출고, 현재 재고, 회전율
-- 힌트: 입고/출고별 CTE 분리 후 통합


-- 문제 13: 재귀 CTE로 소셜 네트워크 관계를 탐색하세요.
-- user_connections 테이블을 이용하여 특정 사용자의 n차 인맥을 조회하세요.
-- 결과: 연결 사용자, 관계 차수, 연결 경로, 공통 인맥 수
-- 힌트: 양방향 관계 고려한 재귀 탐색


-- 문제 14: CTE를 사용하여 ABC 분석을 수행하세요.
-- 상품별 매출 기여도를 계산하여 ABC 등급을 분류하세요.
-- A등급: 상위 80% 매출, B등급: 80-95%, C등급: 나머지
-- 결과: 상품명, 매출액, 누적 매출 비율, ABC 등급
-- 힌트: 누적 합계 계산 CTE 활용


-- 문제 15: 재귀 CTE로 달력 테이블을 생성하세요.
-- 2024년 전체 날짜와 각 날짜의 속성(요일, 주차, 분기 등)을 생성하세요.
-- 결과: 날짜, 요일, 주차, 월, 분기, 휴일여부, 영업일여부
-- 힌트: 날짜 증가 재귀와 날짜 함수 활용